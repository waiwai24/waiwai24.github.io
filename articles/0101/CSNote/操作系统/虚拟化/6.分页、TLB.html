<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># 分页、TLB,分页、TLB</title>
    <link rel="stylesheet" href="/assets/css/notes.min.css">
</head>
<body>
    <div class="main-content-wrapper">
        <main class="content">
            <h1>分页、TLB</h1>
<h2>1.分页地址转换</h2>
<h3>1.1 基本原理</h3>
<ul>
<li>分页(paging)是将地址空间划分成固定大小的分片单元，称为页/页面(page)</li>
<li>相对应的，物理内存同样也要分为相同大小的单元，叫做页帧(page frame)</li>
<li>通过页表（page table）来完成虚拟地址到物理地址的映射</li>
</ul>
<p>虚拟地址位数n，2^n^ = 虚拟地址空间（字节）:</p>
<ul>
<li>虚拟页号（VPN）：virtual page number</li>
<li>页内偏移（Offset）：offset within the page</li>
</ul>
<p>虚拟地址‘21’的转换过程：</p>
<p><img src="/0101/CSNote/操作系统/虚拟化/assets/6.%E5%88%86%E9%A1%B5%E3%80%81TLB/image-20241128110027019.png" alt="image-20241128110027019"></p>
<h3>1.2 页表存放位置</h3>
<p>存在的问题：页表存在内存当中，而页表可能很大</p>
<p>例如：32位地址空间(4GB)，带有4KB的页：20位的VPN，12位的offset
单个页表大小： 4𝑀𝐵 = 2^20^ 𝑒𝑛𝑡𝑟𝑖𝑒𝑠 ∗ 4 𝐵𝑦𝑡𝑒𝑠</p>
<p>寻找到页表的位置：页表基址寄存器（PTBR）</p>
<h3>1.3 页表内容</h3>
<p>页表就是一种数据结构：</p>
<ul>
<li>最简单的形式：线性页表，就是一个数组</li>
<li>OS通过虚拟页号(VPN)检索数组，并在该索引处查找页表项(PTE)，进一步找到物理页帧号(PFN)</li>
<li>一些记录位：
<ul>
<li>有效位(Valid Bit): 表明特定地址转换是否有效</li>
<li>保护位(Protection Bit): 表明页的权限(读，写，执行)</li>
<li>存在位(Present Bit): 表明该页是在内存里还是磁盘上</li>
<li>脏位(Dirty Bit): 表明页面进入内存后是否修改过</li>
<li>参考位/访问位(Reference Bit): 表明追踪页是否被访问</li>
</ul>
</li>
</ul>
<h3>1.4 访问示例</h3>
<pre><code class="language-c">VPN = （VirtualAddress &amp; VPN_MASK）&gt;&gt; SHIFT
PTEAddr = PTBR + (VPN * sizeof(PTE))
PTE = AccessMemory(PTEAddr)
    
offset = VirtualAddress &amp; OFFSET_MASK
PhysAddr = (PTE.PFN &lt;&lt; SHIFT) | offset
Register = AccessMemory(PhysAddr)
</code></pre>
<h2>2.分页中的快速地址转换TLB</h2>
<p>地址转换旁路缓冲存储器(translation lookaside buffer)：</p>
<ul>
<li>是一种硬件，是芯片上MMU（Memory Management Unit）的一部分</li>
<li>核心思想是缓存频繁发生的地址转换</li>
</ul>
<h3>2.1 TLB未命中的处理</h3>
<ul>
<li>CISC上,硬件全权处理：
<ul>
<li>硬件知道页表在内存中的具体位置</li>
<li>硬件遍历页表，找到页表项</li>
<li>取出转换映射，更新TLB，然后重试指令</li>
</ul>
</li>
<li>RISC上，软件处理：
<ul>
<li>出现TLB miss，硬件抛出异常</li>
<li>暂停指令，提升特权级</li>
<li>跳转到陷阱处理程序</li>
</ul>
</li>
</ul>
<h3>2.2 TLB的内容</h3>
<ul>
<li>TLB是全相联的</li>
<li>典型的TLB可能有32，64或128项</li>
<li>硬件并行搜索整个TLB</li>
<li>other bits：有效位，保护位，地址空间标识符（ASID），脏位</li>
</ul>
<h3>2.3 TLB的替换策略</h3>
<p>替换最少使用（LRU，least recently used）</p>

        </main>
    </div>
</body>
</html>