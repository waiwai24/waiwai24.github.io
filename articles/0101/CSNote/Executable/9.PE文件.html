<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># PE文件,PE文件</title>
    <link rel="stylesheet" href="../../../assets/css/notes.min.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="main-content-wrapper">
        <main class="content">
            <h1>PE文件</h1>
<blockquote>
<p>Windows 操作系统下的可执行程序使用PE 文件格式。PE 文件是portable File Format Format（可移植文件）的简写，DLL 和exe 文件都是PE 文件</p>
<p>PE文件是指 32 位可执行文件，也称为PE32。64位的可执行文件称为 PE+ 或 PE32+，是PE(PE32)的一种扩展形式（请注意不是PE64)，没有新的结构加入，只是简单地将以前32位字段扩展成64位</p>
</blockquote>
<p>先给出三张全局性的图片，具体内容可放大查看：</p>
<p><img src="/0101/CSNote/Executable/assets/9.PE%E6%96%87%E4%BB%B6/1379525-20191026162634249-935893360.jpg" alt="1379525-20191026162634249-935893360"></p>
<p><img src="/0101/CSNote/Executable/assets/9.PE%E6%96%87%E4%BB%B6/1379525-20191030090458584-97459483.jpg" alt="1379525-20191030090458584-97459483"></p>
<p><img src="/0101/CSNote/Executable/assets/9.PE%E6%96%87%E4%BB%B6/1379525-20191026162607168-1322217015.jpg" alt="1379525-20191026162607168-1322217015"></p>
<h2>1.基本概述</h2>
<p>PE文件使用的是一个平面地址空间，所有代码和数据都被合并在一起，组成一个很大的结构。文件的内容被分割为不同的区块（Section，又称区段、节等），区块中包含代码或数据，各个区块按页边界来对齐，区块没有大小限制，是一个连续结构。每个块都有它自己在内存中的一套属性，比如：这个块是否包含代码、是否只读或可读/写等</p>
<p><img src="/0101/CSNote/Executable/assets/9.PE%E6%96%87%E4%BB%B6/1776217-20200812170028712-248162522.png" alt="1776217-20200812170028712-248162522"></p>
<p>PE文件的执行顺序：</p>
<ul>
<li>PE 装载器 首先检查 DOS header 里的 PE header 的偏移量。如果找到，则直接跳转到 PE header 的位置</li>
<li>PE装载器 跳转到 PE header 后，第二步要做的就是检查 PE header 是否有效。如果该 PE header 有效，就跳转到 PE header 的尾部</li>
<li>紧跟 PE header 尾部的是节表。PE装载器执行完第二步后开始读取节表中的节段信息，并采用文件映射（ 在执行一个PE文件的时候，Windows并不在一开始就将整个文件读入内存，而是采用与内存映射的机制，也就是说，<strong>Windows装载器在装载的时候仅仅建立好虚拟地址和PE文件之间的映射关系，只有真正执行到某个内存页中的指令或者访问某一页中的数据时，这个页面才会被从磁盘提交到物理内存</strong>，这种机制使文件装入的速度和文件大小没有太大的关系 ）的方法将这些节段映射到内存，<strong>同时附上节表里指定节段的读写属性</strong></li>
<li>PE文件映射入内存后，PE装载器将继续处理PE文件中类似 import table （输入表）的逻辑部分</li>
</ul>
<p>地址：</p>
<ul>
<li><strong>ImageBase</strong>：映射基址，PE 文件在内存空间中的映射起始位置，是个 VA 地址</li>
<li><strong>VA</strong>：Virtual Address，基址，VA = ImageBase + RVA</li>
<li><strong>RVA</strong>：Relatively Virtual Address。偏移（又称“相对虚拟地址”）。相对镜像基址的偏移</li>
<li><strong>FOA</strong>：File Offset Address，文件偏移地址，是相对于文件起始位置的偏移量，用于定位可执行文件中的数据和代码在文件中的位置。通过将文件偏移地址和节表中的指定节的起始位置相加，可以计算出相应的FOA。
<ul>
<li>差值偏移 = RVA - 节.VirtualAddress</li>
<li>FOA = 差值偏移 + 节.PointerToRawData</li>
</ul>
</li>
</ul>
<h2>2.文件头</h2>
<h3>2.1 DOS头</h3>
<p>重点关注的两个对象：</p>
<ul>
<li>e_magic：一个 WORD 类型，值是一个常数 0x4D5A，用文本编辑器查看该值位‘MZ’，可执行文件必须都是’MZ’开头</li>
<li>e_lfanew：为 32 位可执行文件扩展的域，用来表示 DOS头之后的 NT头相对文件起始地址的偏移</li>
</ul>
<h3>2.2 NT头（PE头）</h3>
<pre><code class="language-c">typedef struct _IMAGE_NT_HEADERS {
    DWORD Signature;
    IMAGE_FILE_HEADER FileHeader;
    IMAGE_OPTIONAL_HEADER32 OptionalHeader;
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
</code></pre>
<h4>2.2.1 PE签名</h4>
<p>类似于 DOS头中的 e_magic，其高16位是0，低16是0x4550，用字符表示是 PE</p>
<h4>2.2.2 PE文件头</h4>
<pre><code class="language-c">typedef struct _IMAGE_FILE_HEADER {
    WORD    Machine; //文件运行平台
    WORD    NumberOfSections; //节数量
    DWORD   TimeDateStamp; //PE文件创建时间
    DWORD   PointerToSymbolTable; //COFF文件符号表在文件中的偏移
    DWORD   NumberOfSymbols; //符号表数量
    WORD    SizeOfOptionalHeader; //可选头大小
    WORD    Characteristics; //可执行文件属性
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
</code></pre>
<h4>2.2.3 PE可选头</h4>
<p>虽然叫可选头，但很丰富重要，但不同的平台下是不一样的，例如32位下是IMAGE_OPTIONAL_HEADER32，而在64位下是IMAGE_OPTIONAL_HEADER64</p>
<h3>2.3 节头</h3>
<table>
<thead>
<tr>
<th>节名</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>.bss</td>
<td>未初始化的数据</td>
</tr>
<tr>
<td><strong>.data</strong></td>
<td><strong>代码节</strong></td>
</tr>
<tr>
<td><strong>.edata</strong></td>
<td><strong>导出表</strong></td>
</tr>
<tr>
<td><strong>.idata</strong></td>
<td><strong>导入表</strong></td>
</tr>
<tr>
<td>.idlsym</td>
<td>包含已注册的SEH，它们用以支持IDL属性</td>
</tr>
<tr>
<td>.pdata</td>
<td>异常信息</td>
</tr>
<tr>
<td><strong>.rdata</strong></td>
<td><strong>只读的已初始化数据（用于常量）</strong></td>
</tr>
<tr>
<td><strong>.reloc</strong></td>
<td><strong>重定位信息</strong></td>
</tr>
<tr>
<td><strong>.rsrc</strong></td>
<td><strong>资源目录</strong></td>
</tr>
<tr>
<td>.sbss</td>
<td>与GP相关的未初始化数据</td>
</tr>
<tr>
<td>.sdata</td>
<td>与GP相关的已初始化数据</td>
</tr>
<tr>
<td>.srdata</td>
<td>与GP相关的只读数据</td>
</tr>
<tr>
<td><strong>.text</strong></td>
<td><strong>默认代码节</strong></td>
</tr>
</tbody>
</table>

        </main>
    </div>
    <footer class="footer">
        <p>&copy; 2024 waiwai24. All rights reserved.</p>
    </footer>
    <script src="../../../assets/js/header.js"></script>
    <script src="../../../assets/js/include-header.js"></script>
</body>
</html>