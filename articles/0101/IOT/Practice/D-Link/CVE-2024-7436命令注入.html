<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#  CVE-2024-7436 命令注入,CVE-2024-7436 命令注入</title>
    <link rel="stylesheet" href="../../../../assets/css/notes.min.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="main-content-wrapper">
        <main class="content">
            <h1>CVE-2024-7436 命令注入</h1>
<h2>1.漏洞描述</h2>
<p>在 D-Link DI-8100 16.07 中发现了一个被归类为严重的漏洞。影响 msp_info.htm 文件中的 msp_info_htm 功能。对参数 cmd 的操作会导致命令注入。攻击可能是远程发起的。这个漏洞已经向公众披露，可能会被利用。标识符 VDB-273521 被分配给此漏洞</p>
<h2>2.固件分析</h2>
<p>下载网址：<a href="https://www.dlink.com.cn/techsupport/ProductInfo.aspx?m">https://www.dlink.com.cn/techsupport/ProductInfo.aspx?m</a> = DI-8100</p>
<p>下载 A1 版本固件，后缀为 trx</p>
<p>固件未加密，binwalk 可直接解压</p>
<p>固件使用的是 mips32 位小端</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218090754634.png" alt="image-20250218090754634"></p>
<p>firmAE 可直接进行模拟：</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218095125163.png" alt="image-20250218095125163"></p>
<h2>3.漏洞分析</h2>
<h3>3.1 msp_info_htm</h3>
<p>漏洞描述是影响 msp_info.htm 文件中的 msp_info_htm 功能，找这个文件没看见，但是可以在 jhttpd 文件中匹配到字符，jhttpd 是一个 web 服务，可以在仿真系统的进程当中看到</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218100721069.png" alt="image-20250218100721069"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218101320723.png" alt="image-20250218101320723"></p>
<p>ida 逆向分析 jhttpd 程序，关注 msp_info_htm()函数对 cmd 参数的处理：可以很明显的看到 v28 传给 system 的过程当中没有进行任何过滤 ，漏洞点也就是在这里，传参的时候可能存在命令执行</p>
<p>现在，我们需要分析一下 wys 命令是干什么的，同时还需要确定 httpd_get_parm 函数不会过滤我们的参数值</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218211954029.png" alt="image-20250218211954029"></p>
<p>可以直接在仿真终端运行一下 wys 命令，也可以逆向分析一下（反汇编代码挺简单的），就是对传入的参数进行处理</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218213501515.png" alt="image-20250218213501515"></p>
<p>分析 httpd_get_parm 函数，采取 gdb-multiarch 调试</p>
<p><a href="http://load.sh">load.sh</a>:</p>
<pre><code class="language-shell">set architecture mips 
set endian little
target remote 192.168.0.1:1337
b *0x044D74C #断点在 msp_info_htm()函数处
</code></pre>
<p>访问 <a href="http://192.168.0.1/msp_info.htm">http://192.168.0.1/msp_info.htm</a> 网址，程序才会运行到上面的断点处，因为是直接访问该网站的，所以当程序执行到这里时也就是给 parm 赋值为 0，但后面会跳转到 label_17 直接返回，并且执行完程序，游览器这边会回显给我们没有 flag，根据逆向分析，这里应该是给 flag 传值</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218232725811.png" alt="image-20250218232725811"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218232820074.png" alt="image-20250218232820074"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250218232622528.png" alt="image-20250218232622528"></p>
<p>构造正确的请求：</p>
<p>在 URL 编码中，换行符被表示为 “%0A” 或 “%0D%0A”。“%0A” 表示换行符（LF，Line Feed），“%0D%0A” 表示回车换行符（CRLF，Carriage Return Line Feed），空格编码 “%20”</p>
<pre><code>GET /msp_info.htm?flag=cmd&amp;cmd=;busybox%20ls HTTP/1.1

Host: 192.168.0.1

Accept-Language: en-US,en;q=0.9

Upgrade-Insecure-Requests: 1

User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Accept-Encoding: gzip, deflate, br

Cookie: wys_userid=admin,wys_passwd=520E1BFD4CDE217D0A5824AE7EA60632

Connection: keep-alive
</code></pre>
<p>此时断在了给 parm 赋值的时候，可以看见 s0 寄存器指向输入的参数</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219083659983.png" alt="image-20250219083659983"></p>
<p>第二次 flag = cmd 进入其中进行处理 httpd_get_parm 处理，可以看到返回的 v0 是我们 cmd 的值</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219084805580.png" alt="image-20250219084805580"></p>
<p>但其实在 msp_info_htm 函数中，不止 cmd 参数可以利用，qos 参数同样可以利用，其他的参数都是要求相等才进入 if 里面，但 qos 相等则是不进入 if，继续向下执行，同时，这里的 v4 是对 iface 参数值的解析</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219093833482.png" alt="image-20250219093833482"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219093707500.png" alt="image-20250219093707500"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219082922847.png" alt="image-20250219082922847"></p>
<h3>3.2 upgrade_filter_asp</h3>
<p>其实这个固件的漏洞点不止这一处，我们对 system 函数交叉引用：</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219085524177.png" alt="image-20250219085524177"></p>
<p>可以发现 upgrade_filter_asp()函数中同样未对 parm 进行过滤</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219090028474.png" alt="image-20250219090028474"></p>
<p>验证一下：</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219093250073.png" alt="image-20250219093250073"></p>
<h3>3.3 调用链分析</h3>
<p>gdb 直接附加上 jhttpd 进程，可以看见目前一直处于轮询的一个状态</p>
<p>而异步非阻塞的 httpd_poll（轮询）和其他类似的 HTTP 服务器端点可能会触发对 http_recv 的内部调用以获取客户端发送过来的内容长度等信息</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219094256737.png" alt="image-20250219094256737"></p>
<p>main 函数中也可以看到先初始化，然后进行 httpd_poll()</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219094452164.png" alt="image-20250219094452164"></p>
<p>可以看见 httpd_poll()中的 httpd_do_recv(), 但实际上是跳转到((void (__fastcall *)(int))v8)(v6)，执行的还是 httpd_do_recv()</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219094753597.png" alt="image-20250219094753597"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219095117805.png" alt="image-20250219095117805"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219095057859.png" alt="image-20250219095057859"></p>
<p>httpd_do_recv()函数里面又调用了 recv()函数，可以看到是来自 socket 的连接，执行完后 a1 修改成了 get</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219095624221.png" alt="image-20250219095624221"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219095935413.png" alt="image-20250219095935413"></p>
<p>而 recv()下面又正好进行了一个 get 和 post 请求的判断，get 请求跳转到 label35</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219100026065.png" alt="image-20250219100026065"></p>
<p>label35 又会跳转到 httpd_dowith_get()函数进行下一步处理</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219100135666.png" alt="image-20250219100135666"></p>
<p>v7 是一个重要的变量，可以看到他是我们访问的网站文件，那么他是进入 sub_40C860(v7)函数进行处理</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219100337401.png" alt="image-20250219100337401"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219100341541.png" alt="image-20250219100341541"></p>
<p>sub_40C860()函数中主要是对 v2 进行处理，也就是 s0 寄存器，可以看到，是我们网址后面跟着的参数</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219100834780.png" alt="image-20250219100834780"></p>
<p>httpd_dowith_get()后面会进行一个过滤空格，并且还有一个 httpd_formdata_parse()格式化函数，格式化之后，是把 flag = cmd 单独提出来了</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219101816837.png" alt="image-20250219101816837"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219101749059.png" alt="image-20250219101749059"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219101358321.png" alt="image-20250219101358321"></p>
<p>再下面的 httpd_do_wwwparm()就是对 http 请求报文的处理</p>
<p>httpd_send_file()就是开始真正处理了，里面会有 httpd_check_user()</p>
<p><code> *(_BYTE *)(a1 + 27) == 1 &amp;&amp; *(_DWORD *)(a1 + 103104) &gt;= a2</code> 都无法满足，只能是 v5 = 0</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219110614703.png" alt="image-20250219110614703"></p>
<p>在 httpd_user_auth_cookie()中会取出 cookie 并进行校验</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219111016924.png" alt="image-20250219111016924"></p>
<p>没有登录过，jhttpd还处于轮询状态，但我就已经可以看到bss段admin用户的密码的哈希值了，有些疑惑</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219112828969.png" alt="image-20250219112828969"></p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219112442115.png" alt="image-20250219112442115"></p>
<p>最终 httpd_check_user() 返回的是 0</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219112026779.png" alt="image-20250219112026779"></p>
<p>最终是跳转到 v17 也就是 msp_info_htm()了</p>
<p><img src="/0101/IOT/Practice/D-Link/assets/CVE-2024-7436%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/image-20250219112141341.png" alt="image-20250219112141341"></p>
<h2>4.总结</h2>
<p>由于该漏洞并不是未授权接口，所以必须得有cookie才能够利用</p>
<p>从开发的方面来讲，参数值获取的时候一定要设置好过滤，另外，尽量自行封装system这种危险的函数，不要直接调用，封装的里面也是可以加过滤的</p>

        </main>
    </div>
    <footer class="footer">
        <p>&copy; 2024 waiwai24. All rights reserved.</p>
    </footer>
    <script src="../../../../assets/js/header.js"></script>
    <script src="../../../../assets/js/include-header.js"></script>
</body>
</html>