<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># largebin attack2,largebin attack2</title>
    <link rel="stylesheet" href="../../../../assets/css/notes.min.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="main-content-wrapper">
        <main class="content">
            <h1>largebin attack2</h1>
<h2>1.基本原理</h2>
<p>新版本添加的检查措施：</p>
<p>致使前面的 largebin attack 修改 bk 和 bk_next 的利用难度增大，或者不可利用，因为很难控制 target addr 里的内容</p>
<pre><code class="language-c">else
{
  victim-&gt;fd_nextsize = fwd;
  victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;
  if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))
    malloc_printerr (&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;);
  fwd-&gt;bk_nextsize = victim;
  victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
}
bck = fwd-&gt;bk;
if (bck-&gt;fd != fwd)
  malloc_printerr (&quot;malloc(): largebin double linked list corrupted (bk)&quot;);
</code></pre>
<p>但如果新加入的 chunk 小于 large bin 中的 chunk （即最小的 chunk）会进行如下操作：这里没有对双向链表进行任何检查</p>
<pre><code class="language-c">bck = bin_at (av, victim_index);
fwd = bck-&gt;fd;
if (fwd != bck)
{
	...
    if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))
    {
        fwd = bck;
        bck = bck-&gt;bk;
        victim-&gt;fd_nextsize = fwd-&gt;fd;
        victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;
        fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
	}
...
}

victim-&gt;bk = bck;
victim-&gt;fd = fwd;
fwd-&gt;bk = victim;
bck-&gt;fd = victim;
</code></pre>
<p>因此如果将 largebin 中的最小的 chunk 的 bk_nextsize 指向 &amp;target - 0x20 的位置，然后加入一个更小 chunk 就会将 target 写入新加入 chunk 的地址</p>
<p><img src="/0101/PWN/堆利用/BinAttack/assets/6.largebin_attack2/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE2.drawio.png" alt="未命名绘图 2.drawio"></p>

        </main>
    </div>
    <footer class="footer">
        <p>&copy; 2024 waiwai24. All rights reserved.</p>
    </footer>
    <script src="../../../../assets/js/header.js"></script>
    <script src="../../../../assets/js/include-header.js"></script>
</body>
</html>