<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project</title>
  <link rel="icon" href="assets/images/favicon.png" type="image/png" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/style-project-tool.css" />
  <link rel="stylesheet" href="assets/css/header-style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body class="project-page">
  <div id="header-placeholder"></div>

  <main id="main-content" role="main">
    <div class="project-list" aria-live="polite">
      <article class="project-item" aria-labelledby="proj-title-rust-c2">
        <div class="meta">
          <h3 class="title" id="proj-title-rust-c2">
            <a href="https://github.com/waiwai24/rust-c2-framework" target="_blank" rel="noopener">rust-c2-framework</a>
          </h3>
          <p class="desc">Rust 编写的 C2 框架</p>
          <footer class="card-footer">
            <div class="repo-meta" data-repo="waiwai24/rust-c2-framework" aria-hidden="true">加载中...</div>
          </footer>
        </div>
      </article>

      <article class="project-item" aria-labelledby="proj-title-0101">
        <div class="meta">
          <h3 class="title" id="proj-title-0101">
            <a href="https://github.com/waiwai24/0101" target="_blank" rel="noopener">0101</a>
          </h3>
          <p class="desc">个人笔记仓库</p>
          <footer class="card-footer">
            <div class="repo-meta" data-repo="waiwai24/0101" aria-hidden="true">加载中...</div>
          </footer>
        </div>
      </article>
    </div>
  </main>

  <script>
    // 从 GitHub API 异步获取仓库元数据，并使用 localStorage 缓存
    (async function() {
      const metas = document.querySelectorAll('.repo-meta');
      if (!metas || metas.length === 0) return;

      const CACHE_DURATION = 3600 * 1000; // 缓存1小时

      const renderMeta = (el, data) => {
        const stars = data.stargazers_count ?? 0;
        const lang = data.language ?? '';
        const updated = data.updated_at ? new Date(data.updated_at).toLocaleDateString() : '';
        
        // Generate a color from the language name for the dot
        const langColor = lang ? `#${SDBMHash(lang).toString(16).padStart(6, '0').substring(0, 6)}` : 'transparent';

        el.innerHTML = ''
          + '<span aria-hidden="true" style="display:inline-flex;align-items:center;gap:4px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-star" style="color:#f4d35e;fill:#f4d35e;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> ' + stars + '</span>'
          + (lang ? ('<span style="display:inline-flex;align-items:center;gap:6px;"><span style="width:10px;height:10px;border-radius:50%;background-color:' + langColor + ';"></span><strong>' + lang + '</strong></span>') : '')
          + (updated ? ('<span style="color:var(--color-text-tertiary);font-size:12px;">更新于 ' + updated + '</span>') : '');
      };

      const renderError = (el, repo) => {
        el.textContent = '';
        const a = document.createElement('a');
        a.href = 'https://github.com/' + repo;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = '查看仓库';
        el.appendChild(a);
      };

      for (const el of metas) {
        const repo = el.dataset.repo;
        if (!repo) continue;

        const cacheKey = `repo_meta_${repo.replace('/', '_')}`;
        
        try {
          const cachedItem = localStorage.getItem(cacheKey);
          if (cachedItem) {
            const { data, timestamp } = JSON.parse(cachedItem);
            if (Date.now() - timestamp < CACHE_DURATION) {
              renderMeta(el, data);
              continue;
            }
          }

          const res = await fetch('https://api.github.com/repos/' + repo);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const newData = await res.json();
          
          renderMeta(el, newData);
          localStorage.setItem(cacheKey, JSON.stringify({ data: newData, timestamp: Date.now() }));

        } catch (err) {
          renderError(el, repo);
          console.error('获取仓库信息失败:', repo, err);
        }
      }
    })();

    // Simple hash function to generate a color from a string
    function SDBMHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + (hash << 6) + (hash << 16) - hash;
      }
      return hash >>> 0; // Ensure positive integer
    }
  </script>

  <footer class="footer">
    <p>&copy; 2024 waiwai24. All rights reserved.</p>
  </footer>
  <script src="assets/js/header.js"></script>
  <script src="assets/js/include-header.js"></script>
</body>
</html>