#!/bin/bash

# Python 脚本的路径
PYTHON_SCRIPT="cve-2025-32433.py"
# hosts 文件的路径 (相对于此脚本)
HOSTS_FILE="../hosts.txt"

# 检查 hosts 文件是否存在
if [ ! -f "$HOSTS_FILE" ]; then
    echo "错误: hosts 文件未找到于 $HOSTS_FILE"
    exit 1
fi

# 检查 Python 脚本是否存在
if [ ! -f "$PYTHON_SCRIPT" ]; then
    echo "错误: Python 脚本未找到于 $PYTHON_SCRIPT"
    exit 1
fi

# 逐行读取 hosts 文件
while IFS= read -r line || [[ -n "$line" ]]; do
    # 跳过空行或注释行 (如果需要)
    [[ -z "$line" ]] && continue
    # [[ "$line" =~ ^# ]] && continue # 如果 hosts.txt 中有注释，取消此行的注释

    # 解析 IP 和端口
    if [[ "$line" =~ ^([^:]+):([0-9]+)$ ]]; then
        ip="${BASH_REMATCH[1]}"
        port="${BASH_REMATCH[2]}"
        echo "正在处理: $ip:$port"
        # 执行 Python 脚本
        python "$PYTHON_SCRIPT" -t "$ip" -p "$port"
        # 可以添加一个小的延迟，以避免过快地发送请求
        # sleep 0.1
    else
        echo "警告: 跳过无效行: $line"
    fi
done < "$HOSTS_FILE"

echo "脚本执行完毕。"