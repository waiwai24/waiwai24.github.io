# åˆ†é¡µã€TLB

## 1.åˆ†é¡µåœ°å€è½¬æ¢

### 1.1 åŸºæœ¬åŽŸç†

* åˆ†é¡µ(paging)æ˜¯å°†åœ°å€ç©ºé—´åˆ’åˆ†æˆå›ºå®šå¤§å°çš„åˆ†ç‰‡å•å…ƒï¼Œç§°ä¸ºé¡µ/é¡µé¢(page)
* ç›¸å¯¹åº”çš„ï¼Œç‰©ç†å†…å­˜åŒæ ·ä¹Ÿè¦åˆ†ä¸ºç›¸åŒå¤§å°çš„å•å…ƒï¼Œå«åšé¡µå¸§(page frame)
* é€šè¿‡é¡µè¡¨ï¼ˆpage tableï¼‰æ¥å®Œæˆè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„

è™šæ‹Ÿåœ°å€ä½æ•°nï¼Œ2^n^ = è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰:

* è™šæ‹Ÿé¡µå·ï¼ˆVPNï¼‰ï¼švirtual page number
* é¡µå†…åç§»ï¼ˆOffsetï¼‰ï¼šoffset within the page

è™šæ‹Ÿåœ°å€â€˜21â€™çš„è½¬æ¢è¿‡ç¨‹ï¼š

![image-20241128110027019](./assets/6.åˆ†é¡µã€TLB/image-20241128110027019.png)

### 1.2 é¡µè¡¨å­˜æ”¾ä½ç½®

å­˜åœ¨çš„é—®é¢˜ï¼šé¡µè¡¨å­˜åœ¨å†…å­˜å½“ä¸­ï¼Œè€Œé¡µè¡¨å¯èƒ½å¾ˆå¤§

ä¾‹å¦‚ï¼š32ä½åœ°å€ç©ºé—´(4GB)ï¼Œå¸¦æœ‰4KBçš„é¡µï¼š20ä½çš„VPNï¼Œ12ä½çš„offset
     å•ä¸ªé¡µè¡¨å¤§å°ï¼š 4ð‘€ðµ = 2^20^ ð‘’ð‘›ð‘¡ð‘Ÿð‘–ð‘’ð‘  âˆ— 4 ðµð‘¦ð‘¡ð‘’ð‘ 

å¯»æ‰¾åˆ°é¡µè¡¨çš„ä½ç½®ï¼šé¡µè¡¨åŸºå€å¯„å­˜å™¨ï¼ˆPTBRï¼‰

### 1.3 é¡µè¡¨å†…å®¹

é¡µè¡¨å°±æ˜¯ä¸€ç§æ•°æ®ç»“æž„ï¼š

* æœ€ç®€å•çš„å½¢å¼ï¼šçº¿æ€§é¡µè¡¨ï¼Œå°±æ˜¯ä¸€ä¸ªæ•°ç»„
* OSé€šè¿‡è™šæ‹Ÿé¡µå·(VPN)æ£€ç´¢æ•°ç»„ï¼Œå¹¶åœ¨è¯¥ç´¢å¼•å¤„æŸ¥æ‰¾é¡µè¡¨é¡¹(PTE)ï¼Œè¿›ä¸€æ­¥æ‰¾åˆ°ç‰©ç†é¡µå¸§å·(PFN)
* ä¸€äº›è®°å½•ä½ï¼š
  * æœ‰æ•ˆä½(Valid Bit): è¡¨æ˜Žç‰¹å®šåœ°å€è½¬æ¢æ˜¯å¦æœ‰æ•ˆ
  * ä¿æŠ¤ä½(Protection Bit): è¡¨æ˜Žé¡µçš„æƒé™(è¯»ï¼Œå†™ï¼Œæ‰§è¡Œ)
  * å­˜åœ¨ä½(Present Bit): è¡¨æ˜Žè¯¥é¡µæ˜¯åœ¨å†…å­˜é‡Œè¿˜æ˜¯ç£ç›˜ä¸Š
  * è„ä½(Dirty Bit): è¡¨æ˜Žé¡µé¢è¿›å…¥å†…å­˜åŽæ˜¯å¦ä¿®æ”¹è¿‡
  * å‚è€ƒä½/è®¿é—®ä½(Reference Bit): è¡¨æ˜Žè¿½è¸ªé¡µæ˜¯å¦è¢«è®¿é—®

### 1.4 è®¿é—®ç¤ºä¾‹

```c
VPN = ï¼ˆVirtualAddress & VPN_MASKï¼‰>> SHIFT
PTEAddr = PTBR + (VPN * sizeof(PTE))
PTE = AccessMemory(PTEAddr)
    
offset = VirtualAddress & OFFSET_MASK
PhysAddr = (PTE.PFN << SHIFT) | offset
Register = AccessMemory(PhysAddr)
```



## 2.åˆ†é¡µä¸­çš„å¿«é€Ÿåœ°å€è½¬æ¢TLB

åœ°å€è½¬æ¢æ—è·¯ç¼“å†²å­˜å‚¨å™¨(translation lookaside buffer)ï¼š

* æ˜¯ä¸€ç§ç¡¬ä»¶ï¼Œæ˜¯èŠ¯ç‰‡ä¸ŠMMUï¼ˆMemory Management Unitï¼‰çš„ä¸€éƒ¨åˆ†
* æ ¸å¿ƒæ€æƒ³æ˜¯ç¼“å­˜é¢‘ç¹å‘ç”Ÿçš„åœ°å€è½¬æ¢

### 2.1 TLBæœªå‘½ä¸­çš„å¤„ç†

* CISCä¸Š,ç¡¬ä»¶å…¨æƒå¤„ç†ï¼š
  * ç¡¬ä»¶çŸ¥é“é¡µè¡¨åœ¨å†…å­˜ä¸­çš„å…·ä½“ä½ç½®
  * ç¡¬ä»¶éåŽ†é¡µè¡¨ï¼Œæ‰¾åˆ°é¡µè¡¨é¡¹
  * å–å‡ºè½¬æ¢æ˜ å°„ï¼Œæ›´æ–°TLBï¼Œç„¶åŽé‡è¯•æŒ‡ä»¤
* RISCä¸Šï¼Œè½¯ä»¶å¤„ç†ï¼š
  * å‡ºçŽ°TLB missï¼Œç¡¬ä»¶æŠ›å‡ºå¼‚å¸¸
  * æš‚åœæŒ‡ä»¤ï¼Œæå‡ç‰¹æƒçº§
  * è·³è½¬åˆ°é™·é˜±å¤„ç†ç¨‹åº

### 2.2 TLBçš„å†…å®¹

* TLBæ˜¯å…¨ç›¸è”çš„
* å…¸åž‹çš„TLBå¯èƒ½æœ‰32ï¼Œ64æˆ–128é¡¹
* ç¡¬ä»¶å¹¶è¡Œæœç´¢æ•´ä¸ªTLB
* other bitsï¼šæœ‰æ•ˆä½ï¼Œä¿æŠ¤ä½ï¼Œåœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼ˆASIDï¼‰ï¼Œè„ä½

### 2.3 TLBçš„æ›¿æ¢ç­–ç•¥

æ›¿æ¢æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼Œleast recently usedï¼‰
