# 总线

> 计算机系统是由多个基本模块连接而成，通过总线连接

## 1.总线概述

- 定义：连接两个以上部件或设备的**信息通路**，是各个部件或设备的**共享传输介质**
- 特点：
  - 低成本：一组线路能被多种设备共享
  - 多功能性：易于添加新设备

- 分类：
  - 芯片内总线
  - 通信总线
  - 系统总线

- 信号线类型：
  - 专用信号线：信号线专用来传送某一种信息，使用分立的数据线和地址线
  - 复用信号线：信号线在不同的时间传输不同的信息，数据/地址线分时复用，优点在与减少总线条数，减小体积降低成本，缺点在于总线模块的电路变复杂，且不能并行

- 信息传输方式：串行，并行
- 事务类型：数据传输类型或其他总线操作类型
  - MEM R/W
  - IO R/W
  - 中断响应

- 性能受限于：总线长度，总线连接的设备数
- 总线带宽（单位时间内最大数据传输量）=总线宽度$\times$工作频率
- 仲裁方式：集中式，分布式



## 2.总线结构的分类

### 2.1 单总线结构

> 将CPU，MM和各种IO设配卡通过底板总线互连

* 多设备竞争总线
* 速度差异大的设备连接在一条总线，性能受限
* 扩展能力差

### 2.2 多总线结构

> 将CPU，cache，MM和各种IO适配卡通过局部总线，处理器-主存总线，高速IO总线等互连



## 3.系统总线的组成

### 3.1 数据线

Data Bus：承载在源和目的部件之间传输信息，数据线的宽度反映了一次能够传送的数据的位数

### 3.2 地址线

Address Bus：给出源数据或目的数据所在的主存单元或IO接口的地址，地址线的宽度反映了最大寻址空间

### 3.3 控制线

Control Bus：控制对数据线和地址线的访问和使用，用来传输信号和命令信息，包括时钟，中断，存储器读写，IO读写等



## 4.总线仲裁

* 概念：东多个设备需要使用总线进行通信时，采用某种策略选择一个设备使用总线
* 方法：在总线中引入一个或多个总线主设备，只有主设备才能控制总线
  * 主设备：能发起总线请求并控制总线的设备，如处理器
  * 从设备：只能响应从主设备发来的总线命令的设备，如主存
* 通过总线仲裁来决定总线主设备将获得下次的总线使用权
* 总线仲裁信号：
  * 总线请求线
  * 总线允许线
* 仲裁策略：
  * **等级性**：高优先级的设备应该被先服务
  * **公平性**：即时具有最低优先权的设备也不能永远得不到总线的使用权

### 4.1 集中式仲裁

将控制逻辑放在一个专门的总线控制器或仲裁器中，通过将所有的总线请求集中用一个特定的仲裁算法进行仲裁

#### 4.1.1 菊花链仲裁

* 从最高优先权的设备依次向最低优先权的设备串行相连，如果到达的设备有总线请求，信号就不再往下传了，该设备建立总线busy信号，表示它已经获得了总线的使用权
* 优点：简单，易于扩充设备
* 缺点：不呢保证公平性，限制了总线的性能，对电路故障很敏感

#### 4.1.2 计数器定时查询仲裁

* 假设总线仲裁器中计数初值为0，这时设备2、4都通过BR线发出请求，如果设备不忙既BS为0，计数器开始从0计数。并通过设备地址线查看该设备是否发出请求，如果是，则响应否则继续计数。这里设备0没有请求，继续计数直至2，

  发现设备2有请求则响应，并将BS线设为1。

  如果每次查询计数器都从0开始，那么毫无疑问设备优先级和链式查询一样。如果从中止点开始（如上例中下次查询计数器从2开始计数并查询），那么可以实现循环优先级。也可以用软件设置计数初值为k，那么设备k的优先级最高。

* 优点：灵活

* 缺点：需要增加一组设备线，总线设备控制逻辑复杂，需要对设备号进行译码比较等

#### 4.1.3 独立请求方式仲裁

* 每个总线上的部件都可以请求，但是由总线控制器按⼀定优先次序决定批准某个部件使⽤
* 优点：响应速度块，优先级灵活
* 缺点：控制逻辑复杂，控制线数多

### 4.2 分布式仲裁

没有专门的总线控制器，其逻辑控制分散在各个部件或设备中

#### 4.2.1 自举分布式仲裁

* 优先级固定，各个设备独立决定是否是最高优先级请求者，需请求总线设备在各自对应总线请求线上送出请求信号。在总线仲裁期间，每个设备将比自己优先级高的请求线上的信号取回分析

#### 4.2.2 冲突检测方式仲裁

* 网络通信总线（CSMA，监听）

## 5.总线时序

* 用来定义总线事务中的每一步何时开始，何时结束

* 实现方式：

  * **同步**：用时钟来同步定时
    * 优点：控制逻辑少而速度快
    * 缺点：所有设备在同一时钟速率下运行，以最慢的设备为准；由于时钟偏移问题，同步总线不能很长
  * **异步**：用握手信号定时，即应答的方式，只有当双方都同意时，发送者或接收者才会进入到下一步，协议通过一对附加的握手信号线来实现
    * 优点：灵活，课挂接到各种具有不同工作速度的设备
    * 缺点：接口逻辑较为复杂，对噪声较为敏感（任何时候都可能接收到对方的应答信号）

  * **半同步**：同步+异步结合，通过上升沿时钟信号来解决噪声敏感问题
  * **拆分事务**：从设备准备数据时，释放总线
    * 过程1：主设备获得总线使用权后，将请求事务的类型，地址及其他信息发送到总线，从设备记下这些信息，主设备发完信息后便立马释放总线，其他设备便可以使用总线
    * 过程2：从设备收到主设备的信息后，按照要求准备数据，准备好后，从设备便请求使用总线，获得使用权后，将数据送到总线，主设备便可以接受
    * 优点：系统效率改善
    * 缺点：单独的事务响应时间变长，增加复杂性
  * CPU-处理器总线都采用同步方式，IO总线采用半同步方式，memory总线采用拆分事务方式（可提高总线的有效带宽）